version: '3.8'

services:
  frontend:
    build:
      context: .
      dockerfile: infrastructure/docker/frontend.Dockerfile
    ports:
      - "3000:3000"
    environment:
      - VITE_API_URL=${VITE_API_URL}
      - VITE_PUBLIC_URL=${VITE_PUBLIC_URL}
      - VITE_APP_NAME=${VITE_APP_NAME}
      - VITE_APP_VERSION=${VITE_APP_VERSION}
      - VITE_ENABLE_PWA=${VITE_ENABLE_PWA}
      - VITE_ENABLE_ANALYTICS=${VITE_ENABLE_ANALYTICS}
      - VITE_ENABLE_ERROR_REPORTING=${VITE_ENABLE_ERROR_REPORTING}
      - VITE_DEFAULT_LANGUAGE=${VITE_DEFAULT_LANGUAGE}
      - VITE_ITEMS_PER_PAGE=${VITE_ITEMS_PER_PAGE}
      - VITE_STORAGE_PREFIX=${VITE_STORAGE_PREFIX}
      - VITE_AUTH_TOKEN_KEY=${VITE_AUTH_TOKEN_KEY}
      - VITE_USER_SETTINGS_KEY=${VITE_USER_SETTINGS_KEY}
      - VITE_CACHE_TTL=${VITE_CACHE_TTL}
      - VITE_STALE_TIME=${VITE_STALE_TIME}
      - VITE_RETRY_ATTEMPTS=${VITE_RETRY_ATTEMPTS}
      - VITE_MAX_FILE_SIZE=${VITE_MAX_FILE_SIZE}
      - VITE_ALLOWED_FILE_TYPES=${VITE_ALLOWED_FILE_TYPES}
      - VITE_TOAST_DURATION=${VITE_TOAST_DURATION}
      - VITE_ENABLE_PUSH_NOTIFICATIONS=${VITE_ENABLE_PUSH_NOTIFICATIONS}
    depends_on:
      - backend

  backend:
    build:
      context: .
      dockerfile: infrastructure/docker/backend.Dockerfile
    ports:
      - "8000:8000"
    environment:
      - API_V1_STR=${API_V1_STR}
      - PROJECT_NAME=${PROJECT_NAME}
      - VERSION=${VERSION}
      - BACKEND_CORS_ORIGINS=${BACKEND_CORS_ORIGINS}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - MINIO_URL=${MINIO_URL}
      - MINIO_SECURE=${MINIO_SECURE}
      - MINIO_BUCKET_NAME=${MINIO_BUCKET_NAME}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - ALGORITHM=${ALGORITHM}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES}
      - HOST=${HOST}
      - PORT=${PORT}
      - WORKERS=${WORKERS}
      - RELOAD=${RELOAD}
      - DEBUG=${DEBUG}
      - LOG_LEVEL=${LOG_LEVEL}
    depends_on:
      - postgres
      - redis
      - minio

  postgres:
    image: postgres:15-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  minio:
    image: minio/minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"

volumes:
  postgres_data:
    name: catalog_postgres_data
  redis_data:
    name: catalog_redis_data
  minio_data:
    name: catalog_minio_data
